name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_URL: https://mcp.asksabrina.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📋 Checkout Repository
      uses: actions/checkout@v4

    - name: 🚀 Deploy Application
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /opt/asksabrina-ai-mcp
          ./scripts/deploy.sh

    - name: ⏳ Wait for Application Startup
      run: sleep 50

    - name: 🏥 Health Check
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" -k https://${{ secrets.EC2_HOST }}/health)
        if [ $response -eq 200 ]; then
          echo "✅ Health check passed (HTTP $response)"
        else
          echo "❌ Health check failed (HTTP $response)"
          exit 1
        fi

    - name: 📊 Deployment Summary
      if: always()
      run: |
        echo "### Deployment Summary 🚀" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Application URL:** ${{ env.APP_URL }}" >> $GITHUB_STEP_SUMMARY

    - name: 📢 Slack Notification - Success
      if: success()
      run: |
        curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "attachments": [{
              "color": "#36a64f",
              "text": "*Deployment Completed*",
              "fields": [{
                "title": "Application URL",
                "value": "${{ env.APP_URL }}",
                "short": false
              }],
              "footer": "AI MCP Pipeline",
              "ts": '"$(date +%s)"'
            }]
          }'

    - name: 📢 Slack Notification - Failed
      if: failure()
      run: |
        curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "attachments": [{
              "color": "#FF0000",
              "text": "*Deployment Failed*",
              "fields": [{
                "title": "Application URL",
                "value": "${{ env.APP_URL }}",
                "short": false
              }],
              "footer": "AI MCP Pipeline",
              "ts": '"$(date +%s)"'
            }]
          }'